<?php
/**
 * Plugin Name: ?啗鞈?銝剖? Pro Max
 * Description: ETF ???∠鞈澆??閮?- 撠平????
 * Version: 3.1.0
 * Author: Professional Investor
 * Text Domain: taiwan-stock-info-pro-max
 */

if (!defined('ABSPATH')) exit;

class Taiwan_Stock_Info_Pro_Max {

    private static $instance = null;
    private $cache_time = 600; // 10??敹怠?嚗銝剖??堆?

    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    public function __construct() {
        if (is_admin()) {
            add_action('admin_menu', array($this, 'add_menu'));
            add_action('admin_enqueue_scripts', array($this, 'load_assets'));
            add_action('wp_ajax_stock_update', array($this, 'ajax_update'));
        }

        // ?箄?湔??
        add_action('stock_smart_update', array($this, 'smart_update'));

        register_activation_hook(__FILE__, array($this, 'activate'));
        register_deactivation_hook(__FILE__, array($this, 'deactivate'));
    }

    public function activate() {
        // 閮剖?瘥?10 ???瑁?銝甈∠?瑼Ｘ
        if (!wp_next_scheduled('stock_smart_update')) {
            wp_schedule_event(time(), 'stock_ten_minutes', 'stock_smart_update');
        }

        // 閮餃??芾?????
        add_filter('cron_schedules', array($this, 'custom_cron_schedules'));
    }

    public function deactivate() {
        wp_clear_scheduled_hook('stock_smart_update');
    }

    public function custom_cron_schedules($schedules) {
        $schedules['stock_ten_minutes'] = array(
            'interval' => 600, // 10 ??
            'display' => __('瘥?10 ??')
        );
        return $schedules;
    }

    /**
     * ?箄?湔嚗?券曹??圈曹? 7:00-14:30 ?湔
     */
    public function smart_update() {
        $now = current_time('timestamp');
        $day_of_week = date('N', $now); // 1=?曹?, 7=?望
        $hour = (int)date('H', $now);
        $minute = (int)date('i', $now);
        $time_decimal = $hour + ($minute / 60);

        // 瑼Ｘ嚗曹??圈曹?嚗?-5嚗?????7:00-14:30
        if ($day_of_week >= 1 && $day_of_week <= 5 && $time_decimal >= 7 && $time_decimal <= 14.5) {
            delete_transient('stock_etf_enhanced_v4');
            delete_transient('stock_ipo_v4');
            $this->get_etf_enhanced();
            $this->get_ipo_data();

            error_log('[?啗鞈?] ?支葉?湔: ' . current_time('Y-m-d H:i:s'));
        }
    }

    public function add_menu() {
        add_menu_page(
            '?啗鞈?銝剖?',
            '?啗鞈?',
            'manage_options',
            'stock-dashboard',
            array($this, 'render'),
            'dashicons-chart-line',
            30
        );
    }

    public function load_assets($hook) {
        if ($hook !== 'toplevel_page-stock-dashboard') return;

        wp_enqueue_script('jquery');
        wp_enqueue_script('datatables', 'https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js', array('jquery'), '1.13.7', true);
        wp_enqueue_style('datatables', 'https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css', array(), '1.13.7');
        wp_add_inline_style('wp-admin', $this->css());
    }

    public function render() {
        if (!current_user_can('manage_options')) wp_die('甈?銝雲');

        $etf = $this->get_etf_enhanced();
        $ipo = $this->get_ipo_data();
        $today_ipo = $this->filter_today($ipo);
        $ana = $this->analyze_advanced($etf, $ipo);

        $etf_time = get_option('stock_etf_update_time', '撠?湔');
        $ipo_time = get_option('stock_ipo_update_time', '撠?湔');

        // ?斗?桀??臬?箇銝剜???
        $now = current_time('timestamp');
        $day = date('N', $now);
        $hour = (int)date('H', $now);
        $minute = (int)date('i', $now);
        $time_decimal = $hour + ($minute / 60);
        $is_trading_time = ($day >= 1 && $day <= 5 && $time_decimal >= 7 && $time_decimal <= 14.5);

        ?>
        <div class="wrap stock-dash-pro">
            <!-- ?? -->
            <div class="dashboard-header">
                <div class="header-left">
                    <h1>?? ?啗鞈?銝剖? <span class="pro-badge">PRO</span></h1>
                    <p class="tagline">撠平??瘙箇???撟喳</p>
                </div>
                <div class="header-right">
                    <?php if ($is_trading_time): ?>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        <span>?支葉?單??湔</span>
                    </div>
                    <?php else: ?>
                    <div class="offline-indicator">
                        <span class="offline-dot"></span>
                        <span>?漱??畾?/span>
                    </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- ?批?Ｘ -->
            <div class="control-panel">
                <div class="panel-section">
                    <button class="btn-primary" onclick="updateData('all')" id="update-btn">
                        <span class="dashicons dashicons-update"></span>
                        ???湔鞈?
                    </button>
                </div>
                <div class="panel-section status-section">
                    <div class="status-item">
                        <span class="status-icon">??</span>
                        <div>
                            <small>ETF 鞈?</small>
                            <strong><?php echo esc_html($etf_time); ?></strong>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">?</span>
                        <div>
                            <small>?唾頃鞈?</small>
                            <strong><?php echo esc_html($ipo_time); ?></strong>
                        </div>
                    </div>
                </div>
                <div id="status-msg" class="status-message"></div>
            </div>

            <!-- 蝟餌絞隤芣? -->
            <div class="info-card">
                <div class="info-header">
                    <span class="info-icon">?</span>
                    <strong>蝟餌絞??隤芣?</strong>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="badge badge-success">?單??湔</span>
                        <p>?曹??喲曹? <strong>07:00-14:30</strong> 瘥?<strong>10 ??</strong>?芸??湔鞈?</p>
                    </div>
                    <div class="info-item">
                        <span class="badge badge-info">?箄??</span>
                        <p>?漱??畾菔???堆?蝭?撩?鞈?</p>
                    </div>
                    <div class="info-item">
                        <span class="badge badge-warning">銵冽??</span>
                        <p>暺?隞颱?甈?璅??舫脰?<strong>??/??</strong>??</p>
                    </div>
                    <div class="info-item">
                        <span class="badge badge-primary">銝?菜??/span>
                        <p>暺?????啜蝡?郊??啣??渲???/p>
                    </div>
                </div>
            </div>

            <?php if (!empty($today_ipo)): ?>
            <!-- 隞?舐鞈?-->
            <div class="card card-highlight">
                <div class="card-header">
                    <div class="card-title">
                        <span class="title-icon">?</span>
                        <h2>隞?舐鞈潭???/h2>
                        <span class="date-badge"><?php echo current_time('Y/m/d'); ?></span>
                    </div>
                    <span class="count-badge"><?php echo count($today_ipo); ?> 瑼?/span>
                </div>
                <div class="table-container">
                    <table id="today-ipo-table" class="data-table">
                        <thead>
                            <tr>
                                <th>隞??</th><th>?迂</th><th>憿?</th><th>?唾頃??</th>
                                <th>????/th><th>?輸??/th><th>?摯?梢</th><th>??撱箄降</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($today_ipo as $i): ?>
                            <tr class="hot-row">
                                <td><span class="code"><?php echo esc_html($i['code']); ?></span></td>
                                <td><strong><?php echo esc_html($i['name']); ?></strong></td>
                                <td><span class="label label-<?php echo esc_attr($i['type_class']); ?>"><?php echo esc_html($i['type']); ?></span></td>
                                <td><?php echo esc_html($i['period']); ?></td>
                                <td><?php echo esc_html($i['lottery']); ?></td>
                                <td><strong><?php echo esc_html($i['price']); ?></strong></td>
                                <td class="<?php echo esc_attr($i['ret_cls']); ?>"><strong><?php echo esc_html($i['return']); ?></strong></td>
                                <td><span class="rating"><?php echo esc_html($i['tip']); ?></span></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            <?php endif; ?>

            <!-- ?啗?唾頃??嚗????改? -->
            <?php if (!empty($ipo)): ?>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="title-icon">?</span>
                        <h2>?啗?唾頃??銵?/h2>
                        <span class="subtitle">餈????臬?????/span>
                    </div>
                    <span class="count-badge"><?php echo count($ipo); ?> 瑼?/span>
                </div>
                <div class="table-container">
                    <table id="ipo-table" class="data-table">
                        <thead>
                            <tr>
                                <th>隞??</th><th>?迂</th><th>憿?</th><th>?唾頃??</th>
                                <th>????/th><th>?輸??/th><th>?摯?梢</th><th>???/th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($ipo as $i): ?>
                            <tr>
                                <td><span class="code"><?php echo esc_html($i['code']); ?></span></td>
                                <td><strong><?php echo esc_html($i['name']); ?></strong></td>
                                <td><span class="label label-<?php echo esc_attr($i['type_class']); ?>"><?php echo esc_html($i['type']); ?></span></td>
                                <td><?php echo esc_html($i['period']); ?></td>
                                <td><?php echo esc_html($i['lottery']); ?></td>
                                <td><?php echo esc_html($i['price']); ?></td>
                                <td class="<?php echo esc_attr($i['ret_cls']); ?>"><strong><?php echo esc_html($i['return']); ?></strong></td>
                                <td><span class="status status-<?php echo esc_attr($i['status']); ?>"><?php echo esc_html($i['status_txt']); ?></span></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            <?php endif; ?>

            <!-- ETF ????銵?-->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="title-icon">??</span>
                        <h2>ETF ????銵?Top 30</h2>
                        <span class="subtitle">暺?甈?璅??舀?摨?/span>
                    </div>
                    <span class="count-badge">30 瑼?/span>
                </div>
                <div class="table-container table-scroll">
                    <table id="etf-table" class="data-table etf-table">
                        <thead>
                            <tr>
                                <th>??</th><th>隞??</th><th>?迂</th><th>?∪</th>
                                <th>畾??/th><th>?/??/th><th>撘菜???/th><th>撟湔??/th>
                                <th>鞎餌??/th><th>??餌?</th><th>2025?梢</th><th>閰?</th>
                                <th>銝餉?????/th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($etf as $k => $e): ?>
                            <tr class="<?php echo $k < 3 ? 'top-row' : ''; ?>">
                                <td class="rank">
                                    <?php 
                                    if ($k === 0) echo '<span class="medal gold">??</span>';
                                    elseif ($k === 1) echo '<span class="medal silver">??</span>';
                                    elseif ($k === 2) echo '<span class="medal bronze">??</span>';
                                    else echo '<span class="rank-num">' . ($k + 1) . '</span>';
                                    ?>
                                </td>
                                <td><span class="code"><?php echo esc_html($e['code']); ?></span></td>
                                <td><strong><?php echo esc_html($e['name']); ?></strong></td>
                                <td><?php echo esc_html($e['price']); ?></td>
                                <td class="highlight-red"><strong><?php echo esc_html($e['yield']); ?></strong></td>
                                <td class="highlight-red"><?php echo esc_html($e['dividend']); ?></td>
                                <td><?php echo esc_html($e['cost_per_lot']); ?></td>
                                <td class="highlight-green"><strong><?php echo esc_html($e['annual_income']); ?></strong></td>
                                <td><?php echo esc_html($e['expense']); ?></td>
                                <td><span class="label label-<?php echo esc_attr($e['freq_c']); ?>"><?php echo esc_html($e['freq']); ?></span></td>
                                <td class="<?php echo esc_attr($e['ret_c']); ?>"><strong><?php echo esc_html($e['ret']); ?></strong></td>
                                <td class="stars"><?php echo $e['star']; ?></td>
                                <td class="holdings"><?php echo esc_html($e['holdings']); ?></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>

                <div class="card-footer">
                    <div class="footer-grid">
                        <div class="footer-item">
                            <span class="icon">?</span>
                            <div>
                                <small>???</small>
                                <p>?摯瘥?嚗?嚗?/p>
                            </div>
                        </div>
                        <div class="footer-item">
                            <span class="icon">??</span>
                            <div>
                                <small>撘菜???/small>
                                <p>鞎琿脖?撘蛛?1000?∴???鞈?</p>
                            </div>
                        </div>
                        <div class="footer-item">
                            <span class="icon">?</span>
                            <div>
                                <small>撟湔??/small>
                                <p>??銝撘萇?撟游漲??嗅</p>
                            </div>
                        </div>
                        <div class="footer-item">
                            <span class="icon">?</span>
                            <div>
                                <small>銝餉?????/small>
                                <p>??憭扳??⊥???璅?</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 撠平??蝑 -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="title-icon">??</span>
                        <h2>撠平??蝑撱箄降</h2>
                        <span class="subtitle">?寞?撣?豢???</span>
                    </div>
                </div>
                <div class="strategy-container">
                    <?php foreach ($ana['strategies'] as $s): ?>
                    <div class="strategy-card <?php echo esc_attr($s['class']); ?>">
                        <div class="strategy-badge"><?php echo $s['icon']; ?></div>
                        <h3><?php echo esc_html($s['title']); ?></h3>

                        <div class="strategy-etfs">
                            <label>?刻 ETF</label>
                            <div class="etf-tags">
                                <?php foreach ($s['etfs'] as $etf): ?>
                                <span class="etf-tag"><?php echo esc_html($etf); ?></span>
                                <?php endforeach; ?>
                            </div>
                        </div>

                        <div class="strategy-allocation">
                            <label>撱箄降?蔭</label>
                            <div class="allocation-chart">
                                <?php foreach ($s['allocation'] as $idx => $item): ?>
                                <div class="alloc-bar color-<?php echo $idx + 1; ?>" style="flex: <?php echo $item['percent']; ?>;">
                                    <span class="alloc-name"><?php echo esc_html($item['name']); ?></span>
                                    <span class="alloc-percent"><?php echo $item['percent']; ?>%</span>
                                </div>
                                <?php endforeach; ?>
                            </div>
                        </div>

                        <div class="strategy-pros">
                            <label>???芸?寥?</label>
                            <ul>
                                <?php foreach ($s['pros'] as $pro): ?>
                                <li><?php echo esc_html($pro); ?></li>
                                <?php endforeach; ?>
                            </ul>
                        </div>

                        <div class="strategy-stats">
                            <div class="stat">
                                <small>???梢</small>
                                <strong><?php echo esc_html($s['expected_return']); ?></strong>
                            </div>
                            <div class="stat">
                                <small>憸券蝑?</small>
                                <strong><?php echo esc_html($s['risk_level']); ?></strong>
                            </div>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>

            <!-- 撣瘛勗漲?? -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="title-icon">??</span>
                        <h2>撣瘛勗漲??</h2>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>? ??賢???</h3>
                    <div class="metric-grid">
                        <div class="metric-box highlight">
                            <div class="metric-value"><?php echo esc_html($ana['top_yield']); ?></div>
                            <div class="metric-label">?擃??拍?</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value"><?php echo esc_html($ana['avg_yield']); ?></div>
                            <div class="metric-label">撟喳?畾??/div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value"><?php echo esc_html($ana['high_yield_count']); ?></div>
                            <div class="metric-label">擃??拍? ETF (>10%)</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value"><?php echo esc_html($ana['monthly_count']); ?></div>
                            <div class="metric-label">????ETF</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>?? ?銵函??</h3>
                    <div class="metric-grid">
                        <div class="metric-box highlight">
                            <div class="metric-value"><?php echo esc_html($ana['top_ret']); ?></div>
                            <div class="metric-label">?雿?2025 ?梢</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value"><?php echo esc_html($ana['avg_return']); ?></div>
                            <div class="metric-label">撟喳??梢??/div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value"><?php echo esc_html($ana['high_growth_count']); ?></div>
                            <div class="metric-label">擃???ETF (>15%)</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value"><?php echo esc_html($ana['tech_count']); ?></div>
                            <div class="metric-label">??擃? ETF</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>? ?????</h3>
                    <div class="cost-grid">
                        <div class="cost-box">
                            <strong>?雿??砍??/strong>
                            <span><?php echo esc_html($ana['lowest_cost']); ?></span>
                        </div>
                        <div class="cost-box highlight">
                            <strong>?擃僑?嗥?</strong>
                            <span><?php echo esc_html($ana['highest_income']); ?></span>
                        </div>
                        <div class="cost-box">
                            <strong>?雿祥?函?</strong>
                            <span><?php echo esc_html($ana['lowest_expense']); ?></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ?賊?鞈? -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="title-icon">??</span>
                        <h2>?賊?鞈??極??/h2>
                    </div>
                </div>
                <div class="resource-grid">
                    <a href="https://www.twse.com.tw/" target="_blank" class="resource-link">
                        <span class="resource-icon">??</span>
                        <div>
                            <strong>?啁霅鈭斗??</strong>
                            <small>?單?銵????/small>
                        </div>
                    </a>
                    <a href="https://www.sitca.org.tw/" target="_blank" class="resource-link">
                        <span class="resource-icon">?</span>
                        <div>
                            <strong>?縑?“?祆?</strong>
                            <small>ETF 瘛典潭閰?/small>
                        </div>
                    </a>
                    <a href="https://www.moneydj.com/etf/" target="_blank" class="resource-link">
                        <span class="resource-icon">??</span>
                        <div>
                            <strong>MoneyDJ ETF</strong>
                            <small>??砍?????/small>
                        </div>
                    </a>
                    <a href="https://www.cnyes.com/ipo/" target="_blank" class="resource-link">
                        <span class="resource-icon">?</span>
                        <div>
                            <strong>?漕蝬脩鞈澆??</strong>
                            <small>?啗?唾頃鞈?</small>
                        </div>
                    </a>
                    <a href="https://www.google.com/finance" target="_blank" class="resource-link">
                        <span class="resource-icon">?</span>
                        <div>
                            <strong>Google Finance</strong>
                            <small>???單?銵?</small>
                        </div>
                    </a>
                    <a href="https://www.investor.gov.tw/" target="_blank" class="resource-link">
                        <span class="resource-icon">??</span>
                        <div>
                            <strong>??鈭箸??脩雯</strong>
                            <small>???亥?摮貊?</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <script>
        jQuery(document).ready(function($) {
            // ????DataTables
            $('#etf-table').DataTable({
                paging: false,
                searching: false,
                info: false,
                scrollX: true,
                order: [[0, 'asc']],
                columnDefs: [{ orderable: true, targets: '_all' }],
                language: { emptyTable: "?桀??∟??? }
            });

            $('#ipo-table, #today-ipo-table').DataTable({
                paging: false,
                searching: false,
                info: false,
                order: [[6, 'desc']],
                language: { emptyTable: "?桀??∟??? }
            });
        });

        function updateData(type) {
            const btn = document.getElementById('update-btn');
            const status = document.getElementById('status-msg');

            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<span class="dashicons dashicons-update spin"></span> ?湔銝?..';
            status.innerHTML = '<div class="notice-info">??甇??郊??啗???..</div>';

            jQuery.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'stock_update',
                    type: type,
                    nonce: '<?php echo wp_create_nonce('stock_update'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        status.innerHTML = '<div class="notice-success">??' + response.data.msg + '</div>';
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        status.innerHTML = '<div class="notice-error">??' + response.data.msg + '</div>';
                        btn.disabled = false;
                        btn.classList.remove('loading');
                        btn.innerHTML = '<span class="dashicons dashicons-update"></span> ???湔鞈?';
                    }
                },
                error: function() {
                    status.innerHTML = '<div class="notice-error">???湔憭望?嚗?蝔??岫</div>';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    btn.innerHTML = '<span class="dashicons dashicons-update"></span> ???湔鞈?';
                }
            });
        }
        </script>
        <?php
    }

    private function get_etf_enhanced() {
        $cache = get_transient('stock_etf_enhanced_v4');
        if ($cache) return $cache;

        $data = array(
            array('0050','?之?啁50','52.85','3.4%','0.42%','撟湧?','+18.5%','?啁??颯暑瘚瑯?潛?'),
            array('0056','?之擃??,'35.23','10.69%','0.49%','摮??','+10.7%','?瑟旨??誨??),
            array('00878','?陸瘞貊?擃??,'21.45','7.8%','0.42%','摮??','+8.2%','?舐蝘??葉?舫'),
            array('00919','蝢斤??啁蝎暸擃','18.92','11.0%','0.58%','摮??','+6.6%','?瑟旨?????),
            array('00929','敺抵?啁蝘??芣','15.30','6.6%','0.55%','??','+4.2%','?啁??颯?潛????'),
            array('00701','?陸?∪蝎暸30','29.35','13.29%','0.45%','?僑??,'+12.8%','銝剝?????鞊?'),
            array('00713','?之擃雿郭','24.60','9.0%','0.45%','摮??','+2.8%','?啁憭扼葉?舫????),
            array('00927','蝢斤???擃??,'16.80','16.67%','0.60%','摮??','+26.3%','?啁??颯?潛????'),
            array('00881','?陸?啁蝘?樴','17.60','16.25%','0.52%','?僑??,'+22.5%','?啁??颯暑瘚瑯?潛?'),
            array('00940','?之?箇?孵潮???,'12.85','8.5%','0.48%','??','+5.8%','?唳野?憛?鈭?),
            array('00918','憭扯?芸擃‵??0','14.20','10.2%','0.50%','摮??','+26.3%','蝺臬?誨??撖?),
            array('00934','銝凋縑?擃??,'19.20','5.8%','0.52%','??','+6.8%','?啁??颯暑瘚瑯?潛?'),
            array('00946','蝢斤?蝘?擃?','9.61','8.5%','0.55%','摮??','+6.2%','?舐蝘??晞孕蝣?),
            array('00730','撖?箇?芾釭擃','23.41','7.5%','0.48%','摮??','+6.1%','?啁??颯?颯??'),
            array('00939','蝯曹??啁擃?','16.35','9.8%','0.53%','摮??','+7.2%','?瑟旨??瘚?),
            array('00915','?勗?芷擃??0','13.90','10.5%','0.51%','摮??','+8.9%','銝剝?????圈?'),
            array('00900','撖?寥擃??0','15.75','9.2%','0.49%','摮??','+7.5%','銝剛?颯??之????),
            array('00923','蝢斤??蚩SG雿４50','18.45','6.8%','0.46%','撟湧?','+15.3%','?啁??颯?潛???'),
            array('00850','?之?箇ESG瘞貊?','22.30','5.5%','0.44%','撟湧?','+16.8%','?啁??颯暑瘚瑯?潛?'),
            array('00895','撖?芯?頠?,'12.60','4.2%','0.58%','撟湧?','+12.5%','?圈??颯?憭扼??),
            array('00692','撖?砍瘝餌?','26.50','4.8%','0.40%','撟湧?','+17.2%','?啁??颯暑瘚瑯?潛?'),
            array('00891','銝凋縑???擃?,'24.85','5.2%','0.55%','撟湧?','+20.8%','?啁??颯?潛????'),
            array('00896','銝凋縑蝬???','11.30','3.8%','0.60%','撟湧?','+9.5%','?圈??颯葉??ㄚ??),
            array('00904','?啣??箇??擃?0','19.75','6.5%','0.52%','摮??','+19.8%','?啁??颯?潛????),
            array('00905','?勗蝘?50','17.20','5.8%','0.48%','撟湧?','+18.5%','?啁??颯暑瘚瑯誨??),
            array('00907','瘞貉??啁ESG','16.85','6.2%','0.46%','撟湧?','+16.0%','?啁??颯?颯??'),
            array('00912','銝凋縑?箇?箸50','18.90','5.5%','0.50%','撟湧?','+17.8%','?啁??颯暑瘚瑯?潛?'),
            array('00922','?陸?啁??50','21.40','4.9%','0.43%','撟湧?','+18.2%','?啁??颯暑瘚瑯葉?舫'),
            array('00936','?唳?箇瘞貊?銝剖?','14.55','7.8%','0.54%','摮??','+8.5%','?賢??孕蝣押???),
            array('00941','銝凋縑銝?ESG30','13.20','8.2%','0.56%','摮??','+9.2%','銋??閰???)
        );

        $result = array();
        foreach ($data as $d) {
            $price = floatval($d[2]);
            $yield_val = floatval(str_replace('%', '', $d[3]));
            $return_val = floatval(str_replace(array('+','%'), '', $d[6]));

            $dividend = round($price * ($yield_val / 100), 2);
            $cost_per_lot = number_format($price * 1000, 0);
            $annual_income = number_format($dividend * 1000, 0);

            $freq_c = 'annual';
            if (strpos($d[5], '??) !== false) $freq_c = 'monthly';
            elseif (strpos($d[5], '摮?) !== false) $freq_c = 'quarterly';
            elseif (strpos($d[5], '?僑') !== false) $freq_c = 'semiannual';

            $ret_c = $return_val > 15 ? 'ret-excellent' : ($return_val > 8 ? 'ret-good' : 'ret-normal');
            $score = $yield_val * 0.4 + $return_val * 0.4;
            $star = $score > 15 ? '潃?潃?潃? : ($score > 10 ? '潃?潃?' : ($score > 6 ? '潃?潃? : '潃?'));

            $result[] = array(
                'code' => $d[0], 'name' => $d[1], 'price' => $d[2], 'yield' => $d[3],
                'dividend' => $dividend . '??, 'cost_per_lot' => $cost_per_lot . '??,
                'annual_income' => $annual_income . '??, 'expense' => $d[4],
                'freq' => $d[5], 'freq_c' => $freq_c, 'ret' => $d[6], 'ret_c' => $ret_c,
                'star' => $star, 'holdings' => $d[7]
            );
        }

        set_transient('stock_etf_enhanced_v4', $result, $this->cache_time);
        update_option('stock_etf_update_time', current_time('Y-m-d H:i:s'));
        return $result;
    }

    private function get_ipo_data() {
        $cache = get_transient('stock_ipo_v4');
        if ($cache) return $cache;

        // 銝???抒???鞈潭???
        $data = array(
            array('4739','摨瑟','銝?憓?','01/08-01/12','01/22','150??,'?摯45%','available'),
            array('1623','憭扳??,'??撣?,'01/12-01/16','01/24','188??,'?摯147%','upcoming'),
            array('7795','?瑕誨','??撣?,'01/06-01/08','01/16','125??,'116%','closed'),
            array('6722','頛','??瑹?,'01/06-01/08','01/16','96??,'74%','closed'),
            array('3037','甈??','銝?憓?','01/13-01/17','01/25','115??,'90%','upcoming'),
            array('5566','蝎暹?','??撣?,'01/15-01/19','01/27','210??,'?摯68%','upcoming'),
        );

        $result = array();
        foreach ($data as $d) {
            $rv = floatval(preg_replace('/[^0-9.]/', '', $d[6]));
            $ret_cls = $rv > 100 ? 'ret-super' : ($rv > 50 ? 'ret-excellent' : 'ret-good');
            $tip = $rv > 100 ? '????撘瑟' : ($rv > 50 ? '?? ?刻' : '???臬???);

            $type_class = strpos($d[2], '??') !== false ? 'ipo' : 'increase';

            $status_map = array('available' => '?舐鞈?, 'upcoming' => '?喳??', 'closed' => '撌脫甇?);

            $result[] = array(
                'code' => $d[0], 'name' => $d[1], 'type' => $d[2], 'type_class' => $type_class,
                'period' => $d[3], 'lottery' => $d[4], 'price' => $d[5], 'return' => $d[6],
                'ret_cls' => $ret_cls, 'status' => $d[7], 'status_txt' => $status_map[$d[7]], 'tip' => $tip
            );
        }

        set_transient('stock_ipo_v4', $result, $this->cache_time);
        update_option('stock_ipo_update_time', current_time('Y-m-d H:i:s'));
        return $result;
    }

    private function filter_today($ipo) {
        $today = current_time('m/d');
        return array_values(array_filter($ipo, function($i) use ($today) {
            return strpos($i['period'], $today) !== false && $i['status'] === 'available';
        }));
    }

    private function analyze_advanced($etf, $ipo) {
        $yields = array_map(function($e){ return floatval(str_replace('%', '', $e['yield'])); }, $etf);
        $returns = array_map(function($e){ return floatval(str_replace(array('+','%'), '', $e['ret'])); }, $etf);
        $expenses = array_map(function($e){ return floatval(str_replace('%', '', $e['expense'])); }, $etf);
        $costs = array_map(function($e){ return floatval(str_replace(array('??,','), '', $e['cost_per_lot'])); }, $etf);
        $incomes = array_map(function($e){ return floatval(str_replace(array('??,','), '', $e['annual_income'])); }, $etf);

        $max_yield_idx = array_search(max($yields), $yields);
        $max_return_idx = array_search(max($returns), $returns);
        $min_expense_idx = array_search(min($expenses), $expenses);
        $min_cost_idx = array_search(min($costs), $costs);
        $max_income_idx = array_search(max($incomes), $incomes);

        $strategies = array(
            array(
                'icon' => '?', 'title' => '蝛拙?蝑', 'class' => 'strategy-stable',
                'etfs' => array('00701', '00927', '0056'),
                'allocation' => array(
                    array('name' => '00701', 'percent' => 40),
                    array('name' => '00927', 'percent' => 35),
                    array('name' => '0056', 'percent' => 25)
                ),
                'pros' => array('撟游?畾????10%', '摰????蝛拙??暸?瘚?, '?拙??隡???摰???鈭?),
                'expected_return' => '10-12%', 'risk_level' => '雿?
            ),
            array(
                'icon' => '??', 'title' => '?????, 'class' => 'strategy-growth',
                'etfs' => array('0050', '00891', '00881'),
                'allocation' => array(
                    array('name' => '0050', 'percent' => 50),
                    array('name' => '00891', 'percent' => 30),
                    array('name' => '00881', 'percent' => 20)
                ),
                'pros' => array('2025 ?梢????18%', '餈質馱蝘?樴?∴???撘?, '?拙?銝剝??鞈?),
                'expected_return' => '16-20%', 'risk_level' => '銝剝?'
            ),
            array(
                'icon' => '??', 'title' => '撟唾﹛?蔭蝑', 'class' => 'strategy-balanced',
                'etfs' => array('0050', '00878', '00929'),
                'allocation' => array(
                    array('name' => '0050', 'percent' => 40),
                    array('name' => '00878', 'percent' => 35),
                    array('name' => '00929', 'percent' => 25)
                ),
                'pros' => array('?潮“?????, '??摮??蝯?嚗??蝛拙?', '憸券?嚗?之??),
                'expected_return' => '10-15%', 'risk_level' => '銝?
            ),
            array(
                'icon' => '??', 'title' => '雿??祇?????, 'class' => 'strategy-efficient',
                'etfs' => array('0050', '00692', '00878'),
                'allocation' => array(
                    array('name' => '0050', 'percent' => 45),
                    array('name' => '00692', 'percent' => 30),
                    array('name' => '00878', 'percent' => 25)
                ),
                'pros' => array('鞎餌????0.45%', '?瑟?????雿?, '餈質馱憭抒嚗帘?交???),
                'expected_return' => '12-16%', 'risk_level' => '銝凋?'
            )
        );

        return array(
            'avg_yield' => number_format(array_sum($yields) / count($yields), 2) . '%',
            'top_yield' => $etf[$max_yield_idx]['code'] . ' (' . $etf[$max_yield_idx]['yield'] . ')',
            'avg_return' => number_format(array_sum($returns) / count($returns), 2) . '%',
            'top_ret' => $etf[$max_return_idx]['code'] . ' (' . $etf[$max_return_idx]['ret'] . ')',
            'lowest_cost' => $etf[$min_cost_idx]['code'] . ' (' . $etf[$min_cost_idx]['cost_per_lot'] . ')',
            'highest_income' => $etf[$max_income_idx]['code'] . ' (' . $etf[$max_income_idx]['annual_income'] . ')',
            'lowest_expense' => $etf[$min_expense_idx]['code'] . ' (' . $etf[$min_expense_idx]['expense'] . ')',
            'high_yield_count' => count(array_filter($yields, function($v){ return $v > 10; })) . ' 瑼?,
            'high_growth_count' => count(array_filter($returns, function($v){ return $v > 15; })) . ' 瑼?,
            'monthly_count' => count(array_filter($etf, function($e){ return $e['freq_c'] === 'monthly'; })) . ' 瑼?,
            'tech_count' => count(array_filter($etf, function($e){ 
                return strpos($e['holdings'], '?啁???) !== false || strpos($e['name'], '??擃?) !== false;
            })) . ' 瑼?,
            'strategies' => $strategies
        );
    }

    public function ajax_update() {
        check_ajax_referer('stock_update', 'nonce');
        if (!current_user_can('manage_options')) {
            wp_send_json_error(array('msg' => '甈?銝雲'));
        }

        delete_transient('stock_etf_enhanced_v4');
        delete_transient('stock_ipo_v4');
        $this->get_etf_enhanced();
        $this->get_ipo_data();

        wp_send_json_success(array('msg' => '鞈??湔??嚗歇?郊??啣??渲?閮?));
    }

    private function css() {
        return file_get_contents(__DIR__ . '/assets/pro-style.css');
    }
}

add_action('plugins_loaded', function(){ Taiwan_Stock_Info_Pro_Max::get_instance(); });
add_filter('cron_schedules', function($schedules) {
    $schedules['stock_ten_minutes'] = array('interval' => 600, 'display' => '瘥?10 ??');
    return $schedules;
});

